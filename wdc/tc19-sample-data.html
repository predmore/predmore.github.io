<html>
  <head>
    <title>The Number Will Probably Change</title>
    <meta http-equiv="Cache-Control" content="no-store" />
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.0.latest.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.25/moment-timezone-with-data-10-year-range.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
    <script>
      (function() {
        // the initial seed
        Math.seed = 6;

        // in order to work 'Math.seed' must NOT be undefined,
        // so in any case, you HAVE to provide a Math.seed
        Math.seededRandom = function(min, max) {
          max = max || 1;
          min = min || 0;

          Math.seed = (Math.seed * 9301 + 49297) % 233280;
          var rnd = Math.seed / 233280;

          return min + rnd * (max - min);
        }

        // Desired Schema
        // order_date: Date - The timestamp of the order
        // region: String - The region, either north, south, east, or west
        // product: String - The product that was sold, either A, B, C, D, E, F, G, H, or I
        // quantity: Real - The number of products that were ordered
        // amount: Real - The Number of USD paid for the order
        // customer: String - The name of the customer
        // cost: Real - The amount it will cost to produce the order
        // days_to_ship: Real - the number of days it will take to ship the product

        // Create Test Data
        var possibleRegions = ["north", "south", "east", "west"];
        var possibleProducts = ["A", "B", "C", "D", "E", "F", "G", "H", "I"];
        var quantityRange = { min: 1, max: 100 };
        var amountPerItemRange = { min: 500, max: 750 };
        var possibleCustomers = ["c1", "c2", "c3", "c4", "c5", "c6", "c7", "c8", "c9", "c10"];
        var costPerItemRange = { min: 300, max: 600 };
        var daysToShipRange = { min: 1, max: 10 };
        var numberOfRowsPerDateRange = { min: 1, max: 3 };
        var probabilityOfRowsOnDate = 0.10;

        var generateRowForDate = function(date) {
          var quantity = Math.seededRandom(quantityRange.min, quantityRange.max);
          return {
            "order_date": date.format("MM/DD/YYYY HH:mm:ss"),
            "region": possibleRegions[Math.seededRandom(0, possibleRegions.length)],
            "product": possibleProducts[Math.seededRandom(0, possibleProducts.length)],
            "quantity": quantity,
            "amount": Math.seededRandom(amountPerItemRange.min * 100, amountPerItemRange.max * 100) / 100 * quanity,
            "customer": possibleCustomers[Math.seededRandom(0, possibleCustomers.length)],
            "cost": Math.seededRandom(costPerItemRange.min * 100, costPerItemRange.max * 100) / 100 * quantity,
            "days_to_ship": Math.seededRandom(daysToShipRange.min, daysToShipRange.max)
          };
        };

        var generateRowsForDate = function(date) {
          if (Math.seededRandom(0, 1000000) / 1000000 >= probabilityOfRowsOnDate) {
            return [];
          }

          var numberOfRows = Math.seededRandom(numberOfRowsPerDateRange.min, numberOfRowsPerDateRange.max);

          var rows = [];

          for (var i = 0; i < numberOfRows; i++) {
            rows.push(generateRowForDate(date));
          }

          return rows;
        }

        var generateData = function(startDate, endDate) {
          var currentDate = startDate;

          var rows = [];

          while (currentDate.isBefore(endDate)) {
            var newRows = generateRowsForDate(currentDate);

            rows.push.apply(rows, newRows);

            currentDate = currentDate.add(1, 's');
          }

          return rows;
        };

        // Create the connector object
        var myConnector = tableau.makeConnector();
        // Define the schema
        myConnector.getSchema = function(schemaCallback) {
          schemaCallback([{
            id: "lotsOfData",
            description: "Gives you lots of boring, useless, data",
            columns: [
              {
                id: "order_date",
                description: "The timestamp of the order",
                dataType: tableau.dataTypeEnum.date
              },
              {
                id: "region",
                description: "The region",
                dataType: tableau.dataTypeEnum.string
              },
              {
                id: "product",
                description: "The product that was sold",
                dataType: tableau.dataTypeEnum.string
              },
              {
                id: "quantity",
                description: "The number of products that were ordered",
                dataType: tableau.dataTypeEnum.float
              },
              {
                id: "amount",
                description: "The amount of USD paid for the order",
                dataType: tableau.dataTypeEnum.float
              },
              {
                id: "customer",
                description: "The name of the customer",
                dataType: tableau.dataTypeEnum.string
              },
              {
                id: "cost",
                description: "The amount it will cost to produce an order",
                dataType: tableau.dataTypeEnum.float
              },
              {
                id: "days_to_ship",
                description: "The numbers of days it will take to ship the product",
                dataType: tableau.dataTypeEnum.float
              }
            ]
          }]);
        };
        
        // Download the data
        myConnector.getData = function(table, doneCallback) {
          var count = 20000;

          var now = moment();
          var pacific = now.tz("America/Los_Angeles");

          var startDate = moment("1/1/2019");

          var data = generateData(startDate, now);

          table.appendRows(data);

          doneCallback();
        };
        tableau.registerConnector(myConnector);
        // Create event listeners for when the user submits the form
        $(document).ready(function() {
          setTimeout(function() {
            tableau.submit();
          }, 1000);
        });
      })();
    </script>
  </head>
</html>
